<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°©ì†¡ìš© ì˜¤ë²„ë ˆì´</title>
  <style>
    :root{
      /* ì»¨íŠ¸ë¡¤(control.html)ê³¼ ê³µìœ ë˜ëŠ” ë³€ìˆ˜ (ê¸°ë³¸ê°’ì€ ë³´ë¼ ì¹´ë“œ ëŠë‚Œ) */
      --card-w:640px; --radius:22px; --pad:16px;
      --bg:#7b42f6;   /* ê¸°ë³¸ ë³´ë¼ */
      --alpha:.90;    /* ë¶ˆíˆ¬ëª…ë„(1=ì™„ì „ë¶ˆíˆ¬ëª…) */
      --blur:8px;
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --fg:#ffffff;
      --muted:#e7d7ff;
    }

    html,body{
      height:100%; margin:0;
      background: transparent; /* ì£¼ë³€ íˆ¬ëª… */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
      color: var(--fg);
    }
    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box}

    /* ì¹´ë“œ (ê¸°ë³¸: ë°˜íˆ¬ëª…+ë¸”ëŸ¬) */
    .card{
      width:var(--card-w);
      border-radius:var(--radius);
      padding:var(--pad);
      background: color-mix(in oklab, var(--bg) calc(var(--alpha)*100%), transparent);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      border:1px solid color-mix(in oklab, #fff 8%, #0000);
    }

    /* âœ… solid ëª¨ë“œ: ë¶ˆíˆ¬ëª…, ë¸”ëŸ¬ ì œê±° */
    .solid .card{
      background: var(--bg) !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    .np{display:grid;grid-template-columns:180px 1fr;gap:16px;align-items:center}

    .cover{ width:180px; aspect-ratio:1/1; border-radius:14px; overflow:hidden; border:1px solid #00000022 }
    .cover img{ width:100%; height:100%; object-fit:cover }

    .title{ font-weight:800; font-size:22px; line-height:1.25 }
    .sub{ opacity:.9; font-size:14px; margin-top:2px; color:var(--muted) }

    .ctrls{ display:flex; gap:12px; margin:8px 0 }
    .btn-sm{ width:36px; height:36px; border-radius:999px; border:1px solid #12172333; background:#0e1320; color:#fff; display:grid; place-items:center }
    .play{ width:44px; height:44px; background:#fff; color:#111; border:none }

    .wave{ display:flex; gap:5px; align-items:flex-end; height:56px; margin-top:6px }
    .bar{ width:5px; background:#fff; border-radius:3px; opacity:.25; transition:opacity .12s ease }
    .bar.active{ opacity:1 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="np">
        <div class="cover">
          <!-- referrer ì°¨ë‹¨(í•«ë§í¬ íšŒí”¼), data-coverëŠ” ë””ë²„ê·¸ìš© -->
          <img id="cover" alt="Cover" referrerpolicy="no-referrer" data-cover="">
        </div>
        <div>
          <div class="title" id="title">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
          <div class="sub" id="meta">SINGğŸ¤ 10cm</div>
          <div class="ctrls">
            <div class="btn-sm">â®</div><div class="btn-sm play">â–¶</div><div class="btn-sm">â­</div>
          </div>
          <div class="wave" id="wave"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ========= ê³µí†µ ì„¤ì • ========= */
  const STORAGE_KEY = 'np.overlay.style.v3'; // control.htmlê³¼ ë™ì¼
  const qs = new URLSearchParams(location.search);
  const urlCoverParam = qs.get('cover');     // ì„ì‹œ ê°•ì œ ì»¤ë²„ ì§€ì •ìš©
  const apiUrl = (() => {
    const p = qs.get('api');
    if (p) return p.replace(/(\?|#).*$/,''); // ì¿¼ë¦¬ ì œê±°
    const m = (document.referrer||'').match(/https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec/);
    return m ? m[0] : '';
  })();

  /* âœ… solid ëª¨ë“œ ê°ì§€ */
  if (qs.get('solid') === '1') {
    document.documentElement.classList.add('solid');
    document.documentElement.style.setProperty('--alpha', '1'); // ë¶ˆíˆ¬ëª… ê°•ì œ
  }

  /* ========= ì»¨íŠ¸ë¡¤(localStorage) ìŠ¤íƒ€ì¼ ì ìš© ========= */
  function applyStyleFromLocal(){
    let s = {};
    try { s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(_){}
    const r = document.documentElement;
    if (s.hex)   r.style.setProperty('--bg', s.hex);
    if (typeof s.alpha === 'number') r.style.setProperty('--alpha', String(s.alpha/100));
    if (typeof s.blur === 'number')  r.style.setProperty('--blur', s.blur + 'px');
    if (typeof s.shadow === 'number'){
      const v = s.shadow;
      r.style.setProperty('--shadow', `0 ${6+v/4}px ${18+v/2}px rgba(0,0,0,${0.15+v/160})`);
    }
  }
  applyStyleFromLocal();

  /* ========= ì»¤ë²„ URL ì •ê·œí™” ========= */
  function normalizeCover(url) {
    if (!url) return '';
    url = String(url).trim();

    // GitHub blob â†’ raw
    const blob = url.match(/^https?:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.+)$/);
    if (blob) {
      const [, user, repo, branch, path] = blob;
      return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
    }

    // ìƒëŒ€ê²½ë¡œ â†’ overlay ë””ë ‰í„°ë¦¬ ê¸°ì¤€
    if (!/^https?:\/\//i.test(url) && !url.startsWith('/')) {
      return new URL(url, new URL('./', location.href)).href;
    }

    // ë£¨íŠ¸(/assets/xxx.png) â†’ /overlay/ ë³´ì •
    if (url.startsWith('/')) {
      return new URL('.' + url, 'https://wlgns4776-code.github.io/overlay/').href;
    }

    // http â†’ https í”„ë¡ì‹œ
    if (/^http:\/\//i.test(url)) {
      const withoutProto = url.replace(/^https?:\/\//, '');
      return `https://images.weserv.nl/?url=${encodeURIComponent(withoutProto)}`;
    }

    return url;
  }

  /* ========= ì»¤ë²„ ì ìš© ========= */
  function setCover(src){
    const coverEl = document.getElementById('cover');
    coverEl.dataset.cover = src; // ë””ë²„ê·¸ìš©
    coverEl.onerror = () => {
      const fallback1 = 'https://wlgns4776-code.github.io/overlay/assets/haming.png';
      if (coverEl.src !== fallback1) { coverEl.src = fallback1; return; }
      const fallback2 = 'https://via.placeholder.com/512?text=Cover';
      if (coverEl.src !== fallback2) { coverEl.src = fallback2; }
    };
    coverEl.src = src;
  }

  /* ========= íŒŒí˜• ========= */
  (function(){
    const wave = document.getElementById('wave');
    const bars = 40;
    const heights = Array.from({length:bars},(_,i)=>16+Math.round((Math.sin(i*1.2)*.5+.5)*40));
    const els = heights.map(h => {
      const d = document.createElement('div');
      d.className='bar'; d.style.height=h+'px';
      wave.appendChild(d);
      return d;
    });
    let idx=0;
    setInterval(()=>{
      els.forEach((el,i)=>el.classList.toggle('active', i<=idx));
      idx=(idx+1)%bars;
    }, 260);
  })();

  /* ========= ë°ì´í„° ë¡œë“œ ========= */
  async function fetchData(){
    const titleEl = document.getElementById('title');
    const metaEl  = document.getElementById('meta');

    if(!apiUrl){
      const first = normalizeCover(urlCoverParam) ||
                    'https://wlgns4776-code.github.io/overlay/assets/haming.png';
      setCover(first);
      return;
    }
    try{
      const res = await fetch(apiUrl + '?_=' + Date.now());
      const data = await res.json();

      titleEl.textContent = data.title || 'ì œëª© ì—†ìŒ';
      const singer = data.singer || '';
      const source = data.source || 'SINGğŸ¤';
      metaEl.textContent  = `${source}  ${singer}`.trim();

      const chosen = normalizeCover(urlCoverParam) ||
                     normalizeCover(data.coverUrl) ||
                     'https://wlgns4776-code.github.io/overlay/assets/haming.png';
      setCover(chosen);

      if (data.style && data.style.cardColor){
        document.documentElement.style.setProperty('--bg', data.style.cardColor);
      }
    }catch(e){
      titleEl.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
      setCover('https://wlgns4776-code.github.io/overlay/assets/haming.png');
    }
  }

  fetchData();
  setInterval(fetchData, 4000);
  </script>
</body>
</html>
