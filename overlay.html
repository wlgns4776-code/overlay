<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>지금 재생 · 오버레이</title>
<style>
:root{
  --bg:#0b0b0f; --fg:#f5f7fb; --muted:#a6afbd;
  --border:#243041; --panel:#0f1320; --control:#12172a;
  --radius:16px; --pad:14px; --gap:70px;
  --card-w:640px; --font:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;

  --card-blur:8px; --card-backdrop:rgba(16,19,27,0.55); --card-shadow:0 12px 30px rgba(0,0,0,.35);
  --lyr-blur:8px;  --lyr-backdrop:rgba(16,19,27,0.30);  --lyr-shadow:0 12px 30px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--fg);font-family:var(--font)}
.app{display:grid;grid-template-columns:320px 1fr;height:100%}
.panel{padding:16px;border-right:1px solid var(--border);background:var(--panel);overflow:auto}
.panel h2{font-size:16px;margin:8px 0 12px}
.row{display:flex;align-items:center;gap:8px;margin:10px 0}
.seg{display:flex;gap:6px;flex-wrap:wrap}
.seg button{padding:8px 10px;border:1px solid var(--border);background:var(--control);color:var(--fg);
  border-radius:10px;cursor:pointer;font-size:13px;white-space:nowrap}
.seg button.active{outline:2px solid var(--fg)}
input[type="range"]{width:100%}
input[type="color"]{width:56px;height:32px;border:1px solid var(--border);border-radius:8px;padding:0;background:transparent}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--control);color:var(--fg);cursor:pointer}
.muted{color:var(--muted)} .small{font-size:12px}
.stage{padding:18px;height:100%;overflow:auto}
.now-wrap{display:grid;grid-template-columns: var(--card-w) minmax(28ch, 42ch); gap: var(--gap); align-items: center;}
@media (max-width: 1100px){ .now-wrap{ grid-template-columns: 1fr; align-items:start; } }
@media (max-width: 600px){ .now-wrap{ grid-template-columns: 1fr; } .card{ width:100%; max-width:100%; min-width:0; } }

.card{width:var(--card-w);max-width:var(--card-w);min-width:var(--card-w);border:1px solid var(--border);
  border-radius:var(--radius);padding:var(--pad);backdrop-filter:blur(var(--card-blur));-webkit-backdrop-filter:blur(var(--card-blur));
  background:var(--card-backdrop);box-shadow:var(--card-shadow)}
.np{display:grid;gap:16px;grid-template-columns: 180px 1fr;align-items:center}
.np-cover{width:180px;aspect-ratio:1/1;border-radius:14px;background:#1114;display:flex;align-items:center;justify-content:center;
  overflow:hidden;border:1px solid var(--border)}
.np-cover img{width:100%;height:100%;object-fit:cover}
.np-placeholder{width:100%;height:100%;display:grid;place-items:center;color:#7c8597;font-weight:700;font-size:14px;background:rgba(255,255,255,.03)}
.np-title{font-weight:800;font-size:22px;letter-spacing:.2px;line-height:1.3;white-space:normal;word-break:keep-all;line-break:anywhere}
.np-artist{color:var(--fg);opacity:.85;font-size:14px;margin-top:2px}
.np-progress{display:none}
.np-ctrls{display:flex;align-items:center;gap:14px;margin-top:8px}
.np-btn{width:34px;height:34px;border-radius:999px;border:1px solid var(--border);background:var(--control);display:grid;place-items:center;cursor:pointer}
.np-btn.primary{width:44px;height:44px;background:#fff;color:#111;border:none}
.np-wave{display:flex;gap:5px;align-items:flex-end;height:56px;margin-top:10px}
.np-barline{width:5px;background:#fff;border-radius:3px;opacity:.25;transition:opacity .15s}
.np-barline.active{opacity:1}

.lyrics{border:1px solid var(--border);border-radius:var(--radius);padding:16px;background:var(--lyr-backdrop);
  backdrop-filter:blur(var(--lyr-blur));-webkit-backdrop-filter:blur(var(--lyr-blur));box-shadow:var(--lyr-shadow);
  width:max-content;min-width:28ch;max-width:min(70ch,96vw);max-height:calc(100vh - 80px);overflow:auto;white-space:pre-wrap;line-height:1.55}
.lyrics h3{margin:0 0 8px 0;font-size:16px;color:var(--muted);font-weight:600}

.overlay .app{grid-template-columns:1fr}
.overlay .panel{display:none}
.overlay body{background:transparent}
.overlay .stage{padding:0}
</style>
</head>
<body>
<div class="app">
  <!-- 왼쪽 패널 -->
  <aside class="panel">
    <h2>데이터</h2>
    <div class="small muted">
      API: <span id="apiHint">-</span><br/>
      스타일 API: <span id="styleHint">-</span>
    </div>

    <h2>프리셋</h2>
    <div class="seg" id="presets">
      <button data-preset="dark"  class="active">다크</button>
      <button data-preset="light">라이트</button>
    </div>

    <h2>표시 카드 스타일</h2>
    <div class="row"><label style="width:90px">반경</label><input id="radius" type="range" min="8" max="30" value="16"><span class="muted" id="radiusOut">16px</span></div>

    <h2>카드 배경</h2>
    <div class="row"><label style="width:90px">색상</label><input id="cardColor" type="color" value="#10131b"><span id="cardColorHex" class="muted" style="margin-left:8px">#10131B</span></div>
    <div class="row"><label style="width:90px">투명도</label><input id="cardAlpha" type="range" min="0" max="100" value="55"><span class="muted" id="cardAlphaOut">55%</span></div>

    <h2>가사 배경</h2>
    <div class="row"><label style="width:90px">색상</label><input id="lyrColor" type="color" value="#10131b"><span id="lyrColorHex" class="muted" style="margin-left:8px">#10131B</span></div>
    <div class="row"><label style="width:90px">투명도</label><input id="lyrAlpha" type="range" min="0" max="100" value="30"><span class="muted" id="lyrAlphaOut">30%</span></div>

    <h2>동작</h2>
    <div class="seg">
      <button class="btn" id="saveStyle">스타일 저장(동기화)</button>
      <button class="btn" id="copyLink">현재 스타일 링크 복사</button>
    </div>
    <div class="small muted" id="status"></div>
  </aside>

  <!-- 오른쪽: 카드 + 가사 -->
  <main class="stage">
    <div class="now-wrap">
      <div class="card">
        <div class="np">
          <div class="np-cover">
            <img id="cover" alt="Album cover" src="" style="display:none"/>
            <div class="np-placeholder" id="coverPh">COVER</div>
          </div>
          <div class="np-main">
            <div class="np-title" id="title">불러오는 중…</div>
            <div class="np-artist" id="sub"></div>
            <div class="np-ctrls">
              <button class="np-btn">⏮</button>
              <button class="np-btn primary">▶</button>
              <button class="np-btn">⏭</button>
            </div>
            <div class="np-wave" id="wave"></div>
          </div>
        </div>
      </div>
      <div class="lyrics">
        <h3>가사</h3>
        <div id="lyrics">가사가 여기에 표시됩니다.</div>
      </div>
    </div>
  </main>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  // === 필수: Apps Script JSON 엔드포인트들 ===
  const API_NOW   = (qs.get('api')   || '').trim(); // …/exec?action=now
  const API_STYLE = (qs.get('sapi')  || '').trim(); // …/exec?action=getStyle / setStyle
  const SAVE_KEY  = (qs.get('key')   || '').trim(); // 있다면 setStyle 시 같이 전송
  const OVERLAY   = qs.get('overlay')==='1';

  if (OVERLAY) document.documentElement.classList.add('overlay');
  document.getElementById('apiHint').textContent   = API_NOW   || '(미설정)';
  document.getElementById('styleHint').textContent = API_STYLE || '(미설정)';

  const $ = id => document.getElementById(id);
  const $title=$('title'), $sub=$('sub'), $lyrics=$('lyrics'), $cover=$('cover'), $coverPh=$('coverPh');

  // ===== 파형(장식)
  (function(){
    const wave = $('wave'); if (!wave) return;
    const bars=40;
    const heights = Array.from({length:bars},(_,i)=> 16 + Math.round((Math.sin(i*1.2)*0.5+0.5)*40));
    const els = heights.map(h=>{ const d=document.createElement('div'); d.className='np-barline'; d.style.height=h+'px'; wave.appendChild(d); return d; });
    let idx=0; setInterval(()=>{ els.forEach((el,i)=> el.classList.toggle('active', i<=idx)); idx=(idx+1)%bars; }, 260);
  })();

  // ===== 스타일 적용
  function applyVars({cardColor, cardAlpha, lyrColor, lyrAlpha, radius}){
    // 카드
    const cc = cardColor || '#10131b';
    const ca = Math.max(0, Math.min(100, Number(cardAlpha||55)))/100;
    const {r:cr,g:cg,b:cb} = hexToRgb(cc);
    document.documentElement.style.setProperty('--card-backdrop', `rgba(${cr},${cg},${cb},${ca})`);
    // 가사
    const lc = lyrColor || '#10131b';
    const la = Math.max(0, Math.min(100, Number(lyrAlpha||30)))/100;
    const {r:lr,g:lg,b:lb} = hexToRgb(lc);
    document.documentElement.style.setProperty('--lyr-backdrop', `rgba(${lr},${lg},${lb},${la})`);
    // 반경
    const rad = Number(radius||16); document.documentElement.style.setProperty('--radius', rad+'px');

    // 패널 표시 업데이트
    $('cardColor').value = toHex(cc); $('cardAlpha').value = Math.round(ca*100);
    $('lyrColor').value  = toHex(lc); $('lyrAlpha').value  = Math.round(la*100);
    $('radius').value    = rad;

    $('cardColorHex').textContent = toHex(cc).toUpperCase();
    $('lyrColorHex').textContent  = toHex(lc).toUpperCase();
    $('cardAlphaOut').textContent = Math.round(ca*100)+'%';
    $('lyrAlphaOut').textContent  = Math.round(la*100)+'%';
    $('radiusOut').textContent    = rad+'px';
  }
  function toHex(v){ v=String(v||'').trim(); return v.startsWith('#')?v:('#'+v); }
  function hexToRgb(hex){ const m=toHex(hex).replace('#',''); const v=(m.length===3?m.split('').map(x=>x+x).join(''):m); const n=parseInt(v,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }

  // 패널에서 바꾸면 즉시 반영(로컬)
  ['cardColor','cardAlpha','lyrColor','lyrAlpha','radius'].forEach(id=>{
    $(id).addEventListener('input', ()=>{
      applyVars({
        cardColor:$('cardColor').value,
        cardAlpha:$('cardAlpha').value,
        lyrColor:$('lyrColor').value,
        lyrAlpha:$('lyrAlpha').value,
        radius:$('radius').value
      });
    });
  });

  // 프리셋
  $('presets').addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b) return;
    [...$('presets').children].forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    if (b.dataset.preset==='light') {
      applyVars({ cardColor:'#ffffff', cardAlpha:90, lyrColor:'#ffffff', lyrAlpha:70, radius:$('radius').value });
    } else {
      applyVars({ cardColor:'#10131b', cardAlpha:55, lyrColor:'#10131b', lyrAlpha:30, radius:$('radius').value });
    }
  });

  // ===== 스타일 읽기(동기화)
  async function fetchJson(url){
    const r = await fetch(url, {cache:'no-store'}); return r.json();
  }
  async function loadStyle(){
    if (!API_STYLE) return;        // 스타일 API가 없으면 로컬 모드
    try{
      const s = await fetchJson(API_STYLE + '?action=getStyle');
      applyVars(s||{});
    }catch(_){}
  }
  loadStyle(); setInterval(loadStyle, 2000); // 2초마다 동기화

  // 스타일 저장
  $('saveStyle').addEventListener('click', async ()=>{
    if (!API_STYLE){ $('status').textContent='스타일 API가 없어 로컬로만 적용됩니다.'; return; }
    const cc=$('cardColor').value.replace('#','');
    const ca=$('cardAlpha').value;
    const lc=$('lyrColor').value.replace('#','');
    const la=$('lyrAlpha').value;
    const rad=$('radius').value;
    const url = `${API_STYLE}?action=setStyle&cc=${cc}&ca=${ca}&lc=${lc}&la=${la}&rad=${rad}` + (SAVE_KEY?`&key=${encodeURIComponent(SAVE_KEY)}`:'');
    try{
      const res = await fetchJson(url);
      $('status').textContent = res && res.ok ? '저장 완료(1~2초 내 모든 화면 반영)' : '저장 실패';
    }catch(_){ $('status').textContent='저장 실패'; }
  });

  // “현재 스타일 링크” 복사(로컬 전파: 쿼리스트링에 포함)
  $('copyLink').addEventListener('click', ()=>{
    const base = location.href.split('?')[0];
    const params = new URLSearchParams(location.search);
    // api/sapi/key는 그대로 유지
    params.set('overlay','1');
    params.set('cc', $('cardColor').value.replace('#',''));
    params.set('ca', $('cardAlpha').value);
    params.set('lc', $('lyrColor').value.replace('#',''));
    params.set('la', $('lyrAlpha').value);
    params.set('rad', $('radius').value);
    const url = `${base}?${params.toString()}`;
    navigator.clipboard.writeText(url);
    $('status').textContent='현재 스타일 포함 링크 복사 완료';
  });

  // URL에 cc/ca/lc/la/rad 있으면 초기 스타일로 사용
  (function seedFromQS(){
    const seed = {
      cardColor: qs.get('cc') ? '#'+qs.get('cc') : undefined,
      cardAlpha: qs.get('ca') || undefined,
      lyrColor : qs.get('lc') ? '#'+qs.get('lc') : undefined,
      lyrAlpha : qs.get('la') || undefined,
      radius   : qs.get('rad')|| undefined
    };
    applyVars(seed);
  })();

  // ===== 곡 데이터 폴링
  async function tick(){
    if (!API_NOW) return;
    try{
      const d = await fetchJson(API_NOW);
      const singer = (d && d.singer) ? String(d.singer).trim() : '';
      const title  = (d && d.title ) ? String(d.title ).trim()  : '';
      const lyrics = (d && d.lyrics) ? String(d.lyrics).trim() : '';
      const cover  = (d && d.coverUrl) ? String(d.coverUrl) : ''; // 있으면 사용

      $title.textContent = title || singer || '체크된 곡이 없습니다';
      $sub.textContent   = singer ? `${singer}` : '';
      $lyrics.textContent= lyrics || '가사가 없습니다.';

      if (cover){ $cover.src=cover; $cover.style.display='block'; $coverPh.style.display='none'; }
      else { $cover.style.display='none'; $coverPh.style.display='grid'; }
    }catch(_){}
  }
  tick(); setInterval(tick, 2000);
})();
</script>
</body>
</html>
