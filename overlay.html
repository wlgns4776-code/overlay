<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>방송용 오버레이</title>
  <style>
    :root{
      /* 컨트롤(control.html)과 공유되는 변수 (기본값은 보라 카드 느낌) */
      --card-w:640px; --radius:22px; --pad:16px;
      --bg:#7b42f6;   /* 기본 보라 */
      --alpha:.90;    /* 불투명도(1=완전불투명) */
      --blur:8px;
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --fg:#ffffff;
      --muted:#e7d7ff;
    }

    html,body{
      height:100%; margin:0;
      background: transparent; /* 주변 투명 */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
      color: var(--fg);
    }
    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box}

    /* 카드 */
    .card{
      width:var(--card-w);
      border-radius:var(--radius);
      padding:var(--pad);
      /* Fallback 단색 (구형 엔진 대비) */
      background: rgba(123,66,246,0.9);
      /* 최신 브라우저용 혼합 + 블러 */
      background: color-mix(in oklab, var(--bg) calc(var(--alpha)*100%), transparent);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      border:1px solid color-mix(in oklab, #fff 8%, #0000);
    }
    .np{display:grid;grid-template-columns:180px 1fr;gap:16px;align-items:center}

    .cover{ width:180px; aspect-ratio:1/1; border-radius:14px; overflow:hidden; border:1px solid #00000022 }
    .cover img{ width:100%; height:100%; object-fit:cover }

    .title{ font-weight:800; font-size:22px; line-height:1.25 }
    .sub{ opacity:.9; font-size:14px; margin-top:2px; color:var(--muted) }

    .ctrls{ display:flex; gap:12px; margin:8px 0 }
    .btn-sm{ width:36px; height:36px; border-radius:999px; border:1px solid #12172333; background:#0e1320; color:#fff; display:grid; place-items:center }
    .play{ width:44px; height:44px; background:#fff; color:#111; border:none }

    .wave{ display:flex; gap:5px; align-items:flex-end; height:56px; margin-top:6px }
    .bar{ width:5px; background:#fff; border-radius:3px; opacity:.25; transition:opacity .12s ease }
    .bar.active{ opacity:1 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="np">
        <div class="cover">
          <!-- referrer 차단(핫링크 회피), data-cover는 디버그용 -->
          <img id="cover" alt="Cover" referrerpolicy="no-referrer" data-cover="">
        </div>
        <div>
          <div class="title" id="title">불러오는 중…</div>
          <div class="sub" id="meta">SING🎤 10cm</div>
          <div class="ctrls">
            <div class="btn-sm">⏮</div><div class="btn-sm play">▶</div><div class="btn-sm">⏭</div>
          </div>
          <div class="wave" id="wave"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ========= 공통 설정 ========= */
  const STORAGE_KEY = 'np.overlay.style.v3'; // control.html과 동일
  const qs = new URLSearchParams(location.search);
  const urlCoverParam = qs.get('cover');     // 임시 강제 커버 지정용
  const apiUrl = (() => {
    const p = qs.get('api');
    if (p) return p.replace(/(\?|#).*$/,''); // 쿼리 제거
    // (백업) 리퍼러에서 exec 추출
    const m = (document.referrer||'').match(/https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec/);
    return m ? m[0] : '';
  })();

  /* ========= 컨트롤(localStorage) 스타일 적용 ========= */
  function applyStyleFromLocal(){
    let s = {};
    try { s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(_){}
    const r = document.documentElement;
    if (s.hex)   r.style.setProperty('--bg', s.hex);
    if (typeof s.alpha === 'number') r.style.setProperty('--alpha', String(s.alpha/100));
    if (typeof s.blur === 'number')  r.style.setProperty('--blur', s.blur + 'px');
    if (typeof s.shadow === 'number'){
      const v = s.shadow;
      r.style.setProperty('--shadow', `0 ${6+v/4}px ${18+v/2}px rgba(0,0,0,${0.15+v/160})`);
    }
  }
  applyStyleFromLocal();

  /* ========= 커버 URL 정규화(깃허브/상대경로/루트경로/혼합콘텐츠) ========= */
  function normalizeCover(url) {
    if (!url) return '';
    url = String(url).trim();

    // GitHub blob → raw
    const blob = url.match(/^https?:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.+)$/);
    if (blob) {
      const [, user, repo, branch, path] = blob;
      return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
    }

    // 상대경로 → overlay 디렉터리 기준 절대경로
    if (!/^https?:\/\//i.test(url) && !url.startsWith('/')) {
      return new URL(url, new URL('./', location.href)).href; // e.g. assets/haming.png
    }

    // 루트 절대경로('/assets/...') → /overlay/ 보정
    if (url.startsWith('/')) {
      return new URL('.' + url, 'https://wlgns4776-code.github.io/overlay/').href;
    }

    // 혼합콘텐츠(http) → https 프록시
    if (/^http:\/\//i.test(url)) {
      const withoutProto = url.replace(/^https?:\/\//, '');
      return `https://images.weserv.nl/?url=${encodeURIComponent(withoutProto)}`;
    }

    return url;
  }

  /* ========= 커버 적용(다단계 폴백 + 디버그 표시) ========= */
  function setCover(src){
    const coverEl = document.getElementById('cover');
    coverEl.dataset.cover = src; // 디버그: 실제 사용 URL
    coverEl.onerror = () => {
      // 1차 실패 → 깃허브 Pages에 있는 기본 자산
      const fallback1 = 'https://wlgns4776-code.github.io/overlay/assets/haming.png';
      if (coverEl.src !== fallback1) { coverEl.src = fallback1; return; }
      // 2차 실패 → placeholder
      const fallback2 = 'https://via.placeholder.com/512?text=Cover';
      if (coverEl.src !== fallback2) { coverEl.src = fallback2; }
    };
    coverEl.src = src;
  }

  /* ========= 파형 ========= */
  (function(){
    const wave = document.getElementById('wave');
    const bars = 40;
    const heights = Array.from({length:bars},(_,i)=>16+Math.round((Math.sin(i*1.2)*.5+.5)*40));
    const els = heights.map(h => {
      const d = document.createElement('div');
      d.className='bar'; d.style.height=h+'px';
      wave.appendChild(d);
      return d;
    });
    let idx=0;
    setInterval(()=>{
      els.forEach((el,i)=>el.classList.toggle('active', i<=idx));
      idx=(idx+1)%bars;
    }, 260);
  })();

  /* ========= 데이터 로드 ========= */
  async function fetchData(){
    // 제목/메타 기본 폴백
    const titleEl = document.getElementById('title');
    const metaEl  = document.getElementById('meta');

    if(!apiUrl){
      // api 없으면 param cover나 기본값 사용
      const first = normalizeCover(urlCoverParam) ||
                    'https://wlgns4776-code.github.io/overlay/assets/haming.png';
      setCover(first);
      return;
    }
    try{
      const res = await fetch(apiUrl + '?_=' + Date.now()); // 캐시무효화
      const data = await res.json();

      titleEl.textContent = data.title || '제목 없음';
      const singer = data.singer || '';
      const source = data.source || 'SING🎤';
      metaEl.textContent  = `${source}  ${singer}`.trim();

      // 우선순위: URL 파라미터 cover > API coverUrl > 깃허브 자산
      const chosen = normalizeCover(urlCoverParam) ||
                     normalizeCover(data.coverUrl) ||
                     'https://wlgns4776-code.github.io/overlay/assets/haming.png';
      setCover(chosen);

      // (선택) API가 cardColor를 내려주면 최우선 적용
      if (data.style && data.style.cardColor){
        document.documentElement.style.setProperty('--bg', data.style.cardColor);
      }
    }catch(e){
      titleEl.textContent = '불러오기 실패';
      setCover('https://wlgns4776-code.github.io/overlay/assets/haming.png');
    }
  }

  fetchData();
  setInterval(fetchData, 4000);
  </script>
</body>
</html>
