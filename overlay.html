<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Now Playing • Overlay</title>
<style>
:root{
  --card-w: 640px;
  --radius: 16px;
  --pad: 14px;
  --fg:#f5f7fb;

  /* 서버에서 들어오는 값으로 덮어씀 */
  --card-backdrop: rgba(16,19,27,.55);
  --card-blur: 8px;
  --card-shadow: 0 12px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background: transparent;           /* ✅ 방송용 투명 배경 */
  color:var(--fg); font-family: system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
}

/* 화면 중앙 카드 하나만 */
.wrap{display:grid;place-items:center;height:100%}

/* 카드(고정폭 640px) */
.card{
  width:var(--card-w); max-width:var(--card-w); min-width:var(--card-w);
  border-radius:var(--radius); padding:var(--pad);
  backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur));
  background:var(--card-backdrop); box-shadow:var(--card-shadow);
  border:1px solid rgba(36,48,65,.65);
}

.np{display:grid;grid-template-columns:180px 1fr; gap:16px; align-items:center}
.cover{width:180px;aspect-ratio:1/1;border-radius:14px;overflow:hidden;border:1px solid rgba(36,48,65,.65)}
.cover img{width:100%;height:100%;object-fit:cover;display:block}

.tit{font-weight:800;font-size:22px;line-height:1.3;margin:0 0 2px 0}
.sub{opacity:.9;font-size:14px;margin:0 0 8px 0}
.ctrls{display:flex;align-items:center;gap:10px}
.btn{width:36px;height:36px;border-radius:999px;border:1px solid rgba(36,48,65,.65);background:#0f1421;display:grid;place-items:center}
.btn.primary{width:44px;height:44px;background:#fff;color:#111;border:none}

.wave{display:flex;gap:5px;align-items:flex-end;height:56px;margin-top:10px}
.bar{width:5px;background:#fff;border-radius:3px;opacity:.25;transition:opacity .15s}
.bar.active{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="np">
      <div class="cover"><img id="cov" alt="cover"></div>
      <div>
        <div class="tit" id="title">불러오는 중…</div>
        <div class="sub" id="sub">가수 / SING🎤 임하밍</div>
        <div class="ctrls">
          <div class="btn">⏮</div>
          <div class="btn primary">▶</div>
          <div class="btn">⏭</div>
        </div>
        <div class="wave" id="wave"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== 기본 설정 ===== */
  const qs = new URLSearchParams(location.search);
  const API_BASE = qs.get('api') || '';                   // ?api=GAS_EXEC_URL
  const DEFAULT_COVER = './assets/haming.png';            // 리포지토리의 고정 이미지
  const $ = id => document.getElementById(id);
  const $title=$('title'), $sub=$('sub'), $cov=$('cov');

  /* ===== 파형 ===== */
  const wave = document.getElementById('wave');
  const bars=40, heights = Array.from({length:bars},(_,i)=> 16 + Math.round((Math.sin(i*1.2)*0.5+0.5)*40));
  const barEls = heights.map(h=>{ const d=document.createElement('div'); d.className='bar'; d.style.height=h+'px'; wave.appendChild(d); return d; });
  let idx=0; setInterval(()=>{ barEls.forEach((el,i)=> el.classList.toggle('active', i<=idx)); idx=(idx+1)%bars; }, 260);

  /* ===== 유틸 ===== */
  const hexToRgba = (hex,a=1)=>{const m=hex.replace('#','');const v=(m.length===3?m.split('').map(x=>x+x).join(''):m);const n=parseInt(v,16);return `rgba(${(n>>16)&255},${(n>>8)&255},${n&255},${a})`;};
  const shadowVal = v => {v=Math.max(0,Math.min(100,Number(v))); return `0 ${6+v/4}px ${18+v/2}px rgba(0,0,0,${0.15+v/160})`;};

  /* ===== 데이터/스타일 폴링 ===== */
  async function j(url, opt){ const r=await fetch(url, opt); return r.json(); }

  async function pullNow(){
    if (!API_BASE) return;
    try{
      const d = await j(API_BASE + '?nocache=' + Date.now());
      const singer = (d && d.singer)||''; const title=(d && d.title)||''; const lyrics=(d && d.lyrics)||'';
      if ($title) $title.textContent = title || singer || '체크된 곡이 없습니다';
      if ($sub)   $sub.textContent   = singer ? `${singer} / SING🎤 임하밍` : '';
      if ($cov)   $cov.src = DEFAULT_COVER;
    }catch(e){ /* ignore */ }
  }

  async function pullStyle(){
    if (!API_BASE) return;
    try{
      const c = await j(API_BASE + '?action=getConfig&nocache=' + Date.now());
      const card = c && c.card || {};
      const hex = card.color || '#10131b';
      const a   = (card.alpha ?? 55)/100;
      const blur= (card.blur ?? 8) + 'px';
      const sh  = card.shadow ?? 35;
      document.documentElement.style.setProperty('--card-backdrop', hexToRgba(hex, a));
      document.documentElement.style.setProperty('--card-blur', blur);
      document.documentElement.style.setProperty('--card-shadow', shadowVal(sh));
    }catch(e){/* ignore */}
  }

  pullNow(); pullStyle();
  setInterval(pullNow,   2000);
  setInterval(pullStyle, 2000);
})();
</script>
</body>
</html>
