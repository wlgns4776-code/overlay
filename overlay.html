<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>방송 오버레이</title>
  <style>
    :root{
      --bg: transparent;               /* 방송 프로그램용: 투명 배경 */
      --fg:#f5f7fb; --muted:#a6afbd;
      --border:#243041; --panel:#0f1320; --control:#12172a;
      --radius:16px; --pad:14px; --gap:36px;
      --card-w:640px;
      --card-blur:8px;
      --card-backdrop:rgba(16,19,27,0.55);
      --card-shadow:0 12px 30px rgba(0,0,0,.35);
      --lyr-blur:8px;
      --lyr-backdrop:rgba(16,19,27,0.30);
      --lyr-shadow:0 12px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}

    /* 레이아웃: 카드 + 가사 */
    .stage{padding:12px;height:100%;overflow:hidden}
    .wrap{
      display:grid;
      grid-template-columns: var(--card-w) minmax(28ch, 42ch);
      gap: var(--gap);
      align-items:center;
      width:max-content;
      max-width:100%;
    }
    @media (max-width: 1024px){
      .wrap{ grid-template-columns: 1fr; align-items:start; }
    }

    /* 카드 */
    .card{
      width: var(--card-w);
      max-width: var(--card-w);
      min-width: var(--card-w);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:var(--pad);
      backdrop-filter: blur(var(--card-blur));
      -webkit-backdrop-filter: blur(var(--card-blur));
      background:var(--card-backdrop);
      box-shadow:var(--card-shadow);
    }
    .np{
      display:grid;
      gap:16px;
      grid-template-columns: 180px 1fr;
      align-items:center;
    }
    .np-cover{
      width:180px; aspect-ratio:1/1; border-radius:14px;
      background:#1114; display:flex;align-items:center;justify-content:center;
      overflow:hidden; border:1px solid var(--border);
    }
    .np-cover img{width:100%;height:100%;object-fit:cover}
    .np-placeholder{width:100%;height:100%;display:grid;place-items:center;color:#7c8597;font-weight:700;font-size:14px;background:rgba(255,255,255,.03);}
    .np-title{font-weight:800; font-size:22px; letter-spacing:.2px; line-height:1.3; white-space:normal; word-break:keep-all; }
    .np-artist{opacity:.85;font-size:14px;margin-top:2px}

    /* 파형 */
    .np-wave{display:flex;gap:5px;align-items:flex-end;height:56px;margin-top:10px}
    .np-barline{width:5px;background:#fff;border-radius:3px;opacity:.25;transition:opacity .15s}
    .np-barline.active{opacity:1}

    /* 가사 */
    .lyrics{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      background:var(--lyr-backdrop);
      backdrop-filter: blur(var(--lyr-blur));
      -webkit-backdrop-filter: blur(var(--lyr-blur));
      box-shadow: var(--lyr-shadow);
      width:max-content;
      min-width:28ch;
      max-width:min(70ch,96vw);
      max-height:calc(100vh - 40px);
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.55;
    }
    .lyrics h3{margin:0 0 8px 0; font-size:16px; color:var(--muted); font-weight:600}
  </style>
</head>
<body>
  <main class="stage">
    <div class="wrap">
      <!-- 카드 -->
      <div class="card">
        <div class="np">
          <div class="np-cover">
            <img id="cover" alt="Album cover"
                 src="https://github.com/wlgns4776-code/overlay/blob/main/assets/haming.png"
                 style="display:block"/>

            <div class="np-placeholder" id="coverPh">COVER</div>
          </div>

          <div>
            <div class="np-title" id="title">불러오는 중…</div>
            <div class="np-artist" id="sub"></div>
            <div class="np-wave" id="wave"></div>
          </div>
        </div>
      </div>

      <!-- 가사 -->
      <div class="lyrics">
        <h3>가사</h3>
        <div id="lyrics">가사가 여기에 표시됩니다.</div>
      </div>
    </div>
  </main>

  <script>
    // 1) Apps Script JSON 엔드포인트 (네 주소로 고정)
    const API_BASE = "https://script.google.com/macros/s/AKfycbzZl9ZU6PVI9ClP5WjiJ5iDZ3vQoksyL5ItCQ88VlONSRjBOei-VeLtPcjROG31crQb/exec";

    // 2) (선택) 고정 커버 이미지 쓰고 싶으면 여기에 URL 넣기. 비우면 PLACEHOLDER 보임.
    const DEFAULT_COVER = ""; // 예: "https://i.imgur.com/kp18AoI.jpeg"

    // DOM
    const $ = (id)=>document.getElementById(id);
    const $title = $("title");
    const $sub   = $("sub");
    const $lyrics= $("lyrics");
    const $cover = $("cover");
    const $coverPh = $("coverPh");

    // 파형 그리기
    (function initWave(){
      const wave = $("wave");
      const bars=40;
      const heights = Array.from({length:bars},(_,i)=> 16 + Math.round((Math.sin(i*1.2)*0.5+0.5)*40));
      const els = heights.map(h=>{
        const d=document.createElement('div'); d.className='np-barline'; d.style.height=h+'px'; wave.appendChild(d); return d;
      });
      let idx=0;
      setInterval(()=>{ els.forEach((el,i)=> el.classList.toggle('active', i<=idx)); idx=(idx+1)%bars; }, 260);
    })();

    // 데이터 가져오기
    async function fetchJson(url){
      const res = await fetch(url, {cache:'no-store'});
      const ct = res.headers.get('content-type')||'';
      if (ct.includes('application/json')) return res.json();
      const t = await res.text();
      try { return JSON.parse(t); } catch { return {}; }
    }

    async function tick(initial){
      try{
        const data = await fetchJson(API_BASE + "?nocache=" + Date.now());
        const singer = (data && data.singer) ? String(data.singer).trim() : "";
        const title  = (data && data.title ) ? String(data.title ).trim()  : "";
        const lyrics = (data && data.lyrics) ? String(data.lyrics).trim() : "";
        const coverUrl = (data && data.coverUrl) ? String(data.coverUrl).trim() : DEFAULT_COVER;

        $title.textContent = title || singer || "체크된 곡이 없습니다";
        $sub.textContent   = singer || "";

        $lyrics.textContent = lyrics || "가사가 없습니다.";

        if (coverUrl){
          $cover.src = coverUrl;
          $cover.style.display = "block";
          $coverPh.style.display = "none";
        }else{
          $cover.style.display = "none";
          $coverPh.style.display = "grid";
        }
      }catch(e){
        if (initial){
          $title.textContent = "불러오기에 실패했어요";
          $sub.textContent   = "";
          $lyrics.textContent= "";
        }
        console.error(e);
      }
    }

    tick(true);
    setInterval(tick, 2000);
  </script>
</body>
</html>

