<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°©ì†¡ìš© ì˜¤ë²„ë ˆì´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* ì»¨íŠ¸ë¡¤ê³¼ ë™ì¼ ë³€ìˆ˜ (ê¸°ë³¸ê°’: ë³´ë¼ ì¹´ë“œ ëŠë‚Œ) */
      --card-w:640px; --radius:22px; --pad:16px;
      --bg:#7b42f6;   /* ê¸°ë³¸ ë³´ë¼ */
      --alpha:.90;    /* ë¶ˆíˆ¬ëª…ë„(1=ì™„ì „ë¶ˆíˆ¬ëª…) */
      --blur:8px;
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --fg:#ffffff;
      --muted:#e7d7ff;
    }

    html,body{
      height:100%; margin:0;
      background: transparent; /* ì£¼ë³€ ì™„ì „ íˆ¬ëª… */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
      color: var(--fg);
    }

    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      box-sizing:border-box;
    }

    /* ì¹´ë“œ â€” ì»¨íŠ¸ë¡¤ í”„ë¦¬ë·°ì™€ ë™ì¼í•œ íš¨ê³¼ */
    .card{
      width:var(--card-w);
      border-radius:var(--radius);
      padding:var(--pad);
      /* Fallback ë‹¨ìƒ‰(OBS êµ¬í˜• í¬ë¡œë®´ ëŒ€ë¹„) */
      background: rgba(123,66,246,0.9);
      /* ìµœì‹  ë¸Œë¼ìš°ì €ìš© í˜¼í•©+ë¸”ëŸ¬ */
      background: color-mix(in oklab, var(--bg) calc(var(--alpha)*100%), transparent);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      border:1px solid color-mix(in oklab, #fff 8%, #0000);
    }

    .np{
      display:grid;
      grid-template-columns:180px 1fr;
      gap:16px;
      align-items:center;
    }

    .cover{ width:180px; aspect-ratio:1/1; border-radius:14px; overflow:hidden; border:1px solid #00000022 }
    .cover img{ width:100%; height:100%; object-fit:cover }

    .title{ font-weight:800; font-size:22px; line-height:1.25 }
    .sub{ opacity:.9; font-size:14px; margin-top:2px; color:var(--muted) }

    .ctrls{ display:flex; gap:12px; margin:8px 0 }
    .btn-sm{ width:36px; height:36px; border-radius:999px; border:1px solid #12172333; background:#0e1320; color:#fff; display:grid; place-items:center }
    .play{ width:44px; height:44px; background:#fff; color:#111; border:none }

    .wave{ display:flex; gap:5px; align-items:flex-end; height:56px; margin-top:6px }
    .bar{ width:5px; background:#fff; border-radius:3px; opacity:.25; transition:opacity .12s ease }
    .bar.active{ opacity:1 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="np">
        <div class="cover"><img id="cover" alt="Cover"></div>
        <div>
          <div class="title" id="title">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
          <div class="sub" id="meta">ê°€ìˆ˜ / SINGğŸ¤ ì„í•˜ë°</div>
          <div class="ctrls">
            <div class="btn-sm">â®</div><div class="btn-sm play">â–¶</div><div class="btn-sm">â­</div>
          </div>
          <div class="wave" id="wave"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ====== ì„¤ì •/ê³µìš© ====== */
  const STORAGE_KEY = 'np.overlay.style.v3'; // control.htmlê³¼ ë™ì¼
  const params = new URLSearchParams(location.search);
  const apiUrl = (() => {
    const p = params.get('api');
    if (p) return p.replace(/(\?|#).*$/,''); // ì¿¼ë¦¬ ì œê±°
    // ë¦¬í¼ëŸ¬ì— execê°€ ìˆì„ ë•Œ ì¶”ì¶œ(ë°±ì—…)
    const m = (document.referrer||'').match(/https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec/);
    return m ? m[0] : '';
  })();

  /* ====== ë¡œì»¬ì— ì €ì¥ëœ ìŠ¤íƒ€ì¼ ì ìš©(ì»¨íŠ¸ë¡¤ê³¼ ë™ì¼ ë³€ìˆ˜) ====== */
  function applyStyleFromLocal(){
    let s = {};
    try { s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(_){}
    const r = document.documentElement;
    if (s.hex)   r.style.setProperty('--bg', s.hex);
    if (typeof s.alpha === 'number') r.style.setProperty('--alpha', String(s.alpha/100));
    if (typeof s.blur === 'number')  r.style.setProperty('--blur', s.blur + 'px');
    if (typeof s.shadow === 'number'){
      const v = s.shadow;
      r.style.setProperty('--shadow', `0 ${6+v/4}px ${18+v/2}px rgba(0,0,0,${0.15+v/160})`);
    }
  }
  applyStyleFromLocal();

  /* ====== íŒŒí˜• ====== */
  (function(){
    const wave = document.getElementById('wave');
    const bars = 40;
    const heights = Array.from({length:bars},(_,i)=>16+Math.round((Math.sin(i*1.2)*.5+.5)*40));
    const els = heights.map(h => {
      const d = document.createElement('div');
      d.className='bar'; d.style.height=h+'px';
      wave.appendChild(d);
      return d;
    });
    let idx=0;
    setInterval(()=>{
      els.forEach((el,i)=>el.classList.toggle('active', i<=idx));
      idx=(idx+1)%bars;
    }, 260);
  })();

  /* ====== ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ====== */
  async function fetchData(){
    if(!apiUrl) return;
    try{
      const res = await fetch(apiUrl + '?_=' + Date.now()); // ìºì‹œë¬´íš¨í™”
      const data = await res.json();

      document.getElementById('title').textContent = data.title || 'ì œëª© ì—†ìŒ';
      // "ê°€ìˆ˜ / SINGğŸ¤ ì´ë¦„" í˜•íƒœ ìœ ì§€
      const singer = data.singer || '';
      const source = data.source || 'SINGğŸ¤';
      document.getElementById('meta').textContent = `${source} ${singer}`.trim();

      const cover = data.coverUrl || 'https://via.placeholder.com/512?text=Cover';
      document.getElementById('cover').src = cover;

      // (ì„ íƒ) APIê°€ cardColorë¥¼ ì¤„ ë•ŒëŠ” ìµœìš°ì„ ìœ¼ë¡œ ë°˜ì˜
      if (data.style && data.style.cardColor){
        document.documentElement.style.setProperty('--bg', data.style.cardColor);
        // alpha/blur/shadowë„ ë‚´ë ¤ì¤„ ìˆ˜ ìˆìœ¼ë©´ ì—¬ê¸°ì— ì¶”ê°€ ë°˜ì˜
      }
    }catch(e){
      document.getElementById('title').textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
    }
  }
  fetchData();
  setInterval(fetchData, 4000);
  </script>
</body>
</html>
