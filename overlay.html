<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>방송용 오버레이</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* 컨트롤과 동일 변수 (기본값: 보라 카드 느낌) */
      --card-w:640px; --radius:22px; --pad:16px;
      --bg:#7b42f6;   /* 기본 보라 */
      --alpha:.90;    /* 불투명도(1=완전불투명) */
      --blur:8px;
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --fg:#ffffff;
      --muted:#e7d7ff;
    }

    html,body{
      height:100%; margin:0;
      background: transparent; /* 주변 완전 투명 */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
      color: var(--fg);
    }

    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      box-sizing:border-box;
    }

    /* 카드 — 컨트롤 프리뷰와 동일한 효과 */
    .card{
      width:var(--card-w);
      border-radius:var(--radius);
      padding:var(--pad);
      /* Fallback 단색(OBS 구형 크로뮴 대비) */
      background: rgba(123,66,246,0.9);
      /* 최신 브라우저용 혼합+블러 */
      background: color-mix(in oklab, var(--bg) calc(var(--alpha)*100%), transparent);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      border:1px solid color-mix(in oklab, #fff 8%, #0000);
    }

    .np{
      display:grid;
      grid-template-columns:180px 1fr;
      gap:16px;
      align-items:center;
    }

    .cover{ width:180px; aspect-ratio:1/1; border-radius:14px; overflow:hidden; border:1px solid #00000022 }
    .cover img{ width:100%; height:100%; object-fit:cover }

    .title{ font-weight:800; font-size:22px; line-height:1.25 }
    .sub{ opacity:.9; font-size:14px; margin-top:2px; color:var(--muted) }

    .ctrls{ display:flex; gap:12px; margin:8px 0 }
    .btn-sm{ width:36px; height:36px; border-radius:999px; border:1px solid #12172333; background:#0e1320; color:#fff; display:grid; place-items:center }
    .play{ width:44px; height:44px; background:#fff; color:#111; border:none }

    .wave{ display:flex; gap:5px; align-items:flex-end; height:56px; margin-top:6px }
    .bar{ width:5px; background:#fff; border-radius:3px; opacity:.25; transition:opacity .12s ease }
    .bar.active{ opacity:1 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="np">
        <div class="cover"><img id="cover" alt="Cover"></div>
        <div>
          <div class="title" id="title">불러오는 중…</div>
          <div class="sub" id="meta">가수 / SING🎤 임하밍</div>
          <div class="ctrls">
            <div class="btn-sm">⏮</div><div class="btn-sm play">▶</div><div class="btn-sm">⏭</div>
          </div>
          <div class="wave" id="wave"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ====== 설정/공용 ====== */
  const STORAGE_KEY = 'np.overlay.style.v3'; // control.html과 동일
  const params = new URLSearchParams(location.search);
  const apiUrl = (() => {
    const p = params.get('api');
    if (p) return p.replace(/(\?|#).*$/,''); // 쿼리 제거
    // 리퍼러에 exec가 있을 때 추출(백업)
    const m = (document.referrer||'').match(/https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec/);
    return m ? m[0] : '';
  })();

  /* ====== 로컬에 저장된 스타일 적용(컨트롤과 동일 변수) ====== */
  function applyStyleFromLocal(){
    let s = {};
    try { s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(_){}
    const r = document.documentElement;
    if (s.hex)   r.style.setProperty('--bg', s.hex);
    if (typeof s.alpha === 'number') r.style.setProperty('--alpha', String(s.alpha/100));
    if (typeof s.blur === 'number')  r.style.setProperty('--blur', s.blur + 'px');
    if (typeof s.shadow === 'number'){
      const v = s.shadow;
      r.style.setProperty('--shadow', `0 ${6+v/4}px ${18+v/2}px rgba(0,0,0,${0.15+v/160})`);
    }
  }
  applyStyleFromLocal();

  /* ====== 파형 ====== */
  (function(){
    const wave = document.getElementById('wave');
    const bars = 40;
    const heights = Array.from({length:bars},(_,i)=>16+Math.round((Math.sin(i*1.2)*.5+.5)*40));
    const els = heights.map(h => {
      const d = document.createElement('div');
      d.className='bar'; d.style.height=h+'px';
      wave.appendChild(d);
      return d;
    });
    let idx=0;
    setInterval(()=>{
      els.forEach((el,i)=>el.classList.toggle('active', i<=idx));
      idx=(idx+1)%bars;
    }, 260);
  })();

  /* ====== 데이터 가져오기 ====== */
  async function fetchData(){
    if(!apiUrl) return;
    try{
      const res = await fetch(apiUrl + '?_=' + Date.now()); // 캐시무효화
      const data = await res.json();

      document.getElementById('title').textContent = data.title || '제목 없음';
      // "가수 / SING🎤 이름" 형태 유지
      const singer = data.singer || '';
      const source = data.source || 'SING🎤';
      document.getElementById('meta').textContent = `${source} ${singer}`.trim();

      const cover = data.coverUrl || 'https://via.placeholder.com/512?text=Cover';
      document.getElementById('cover').src = cover;

      // (선택) API가 cardColor를 줄 때는 최우선으로 반영
      if (data.style && data.style.cardColor){
        document.documentElement.style.setProperty('--bg', data.style.cardColor);
        // alpha/blur/shadow도 내려줄 수 있으면 여기에 추가 반영
      }
    }catch(e){
      document.getElementById('title').textContent = '불러오기 실패';
    }
  }
  fetchData();
  setInterval(fetchData, 4000);
  </script>
</body>
</html>
