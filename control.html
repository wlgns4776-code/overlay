<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Overlay Control</title>
<style>
  :root{ --bg:#0f1320; --fg:#f5f7fb; --muted:#a6afbd; --panel:#12172a; --border:#243041; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
  .wrap{max-width:880px;margin:0 auto;padding:20px;display:grid;gap:16px}
  .box{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  h1{font-size:20px;margin:0 0 10px}
  h2{font-size:16px;margin:0 0 10px;color:var(--muted)}
  label{display:block;margin:10px 0 6px}
  input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#1a2440;color:#fff}
  .row{display:flex;gap:10px;align-items:center;margin:8px 0}
  input[type="color"]{width:56px;height:32px;border-radius:8px;border:1px solid var(--border);background:transparent}
  input[type="range"]{flex:1}
  .btn{padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#2d3b52;color:#fff;cursor:pointer}
  .btn:hover{background:#3b4c6b}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:760px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ› Overlay Control</h1>

  <div class="box">
    <h2>1) Apps Script JSON API</h2>
    <label>ì‹¤í–‰ URL( /exec )</label>
    <input id="api" type="text" placeholder="ì˜ˆ: https://script.google.com/macros/s/XXXXXXXX/exec" />
    <div class="row">
      <button class="btn" id="saveApi">ì €ì¥</button>
      <span class="muted">ì €ì¥í•˜ë©´ ì•„ë˜ ì£¼ì†Œì— ìë™ ë°˜ì˜ë¼ìš”.</span>
    </div>
  </div>

  <div class="box grid">
    <div>
      <h2>2) ì¹´ë“œ ìŠ¤íƒ€ì¼</h2>
      <div class="row"><label>ë°°ê²½ìƒ‰</label><input type="color" id="cardHex" value="#10131b"></div>
      <div class="row"><label>íˆ¬ëª…ë„</label><input type="range" id="cardAlpha" min="0" max="100" value="55"><span id="cardAlphaOut" class="muted">55%</span></div>
      <div class="row"><label>ë¸”ëŸ¬</label><input type="range" id="cardBlur" min="0" max="30" value="8"><span id="cardBlurOut" class="muted">8px</span></div>
      <div class="row"><label>ê·¸ë¦¼ì</label><input type="range" id="cardShadow" min="0" max="100" value="35"><span id="cardShadowOut" class="muted">35</span></div>
      <div class="row"><label>ëª¨ì„œë¦¬ ë°˜ê²½</label><input type="range" id="radius" min="0" max="40" value="16"><span id="radiusOut" class="muted">16px</span></div>

      <div class="row" style="margin-top:12px;gap:8px">
        <button class="btn" id="sendRealtime">ê°™ì€ PC ì˜¤ë²„ë ˆì´ì— ì‹¤ì‹œê°„ ì ìš©</button>
        <span class="muted">OBS/í”„ë¦­ìƒ· ë¸Œë¼ìš°ì € ì†ŒìŠ¤ê°€ ê°™ì€ PCì—ì„œ <code>overlay.html</code>ì„ ì—´ê³  ìˆìœ¼ë©´ ì¦‰ì‹œ ë°˜ì˜</span>
      </div>
    </div>

    <div>
      <h2>3) ë°©ì†¡/íŒì—… ì£¼ì†Œ</h2>
      <label>ë°©ì†¡ìš©(ì¹´ë“œë§Œ) ì£¼ì†Œ</label>
      <input id="overlayUrl" type="text" readonly />
      <div class="row">
        <button class="btn" id="copyOverlay">ë³µì‚¬</button>
        <button class="btn" id="openOverlay">ë¯¸ë¦¬ë³´ê¸°</button>
      </div>

      <label style="margin-top:12px">ê°€ì‚¬ íŒì—… ì£¼ì†Œ</label>
      <input id="lyricsUrl" type="text" readonly />
      <div class="row">
        <button class="btn" id="copyLyrics">ë³µì‚¬</button>
        <button class="btn" id="openLyrics">íŒì—… ì—´ê¸°</button>
      </div>

      <div class="muted" style="margin-top:8px">
        â€¢ ë°©ì†¡ í”„ë¡œê·¸ë¨ì—ëŠ” <strong>ë°©ì†¡ìš©(ì¹´ë“œë§Œ) ì£¼ì†Œ</strong>ë¥¼ ë¸Œë¼ìš°ì € ì†ŒìŠ¤ë¡œ ë“±ë¡í•˜ì„¸ìš”.<br>
        â€¢ ê°€ì‚¬ëŠ” í•„ìš”í•  ë•Œë§Œ íŒì—… ë²„íŠ¼ìœ¼ë¡œ ë³„ë„ ì°½ì—ì„œ ë´…ë‹ˆë‹¤.
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const GH_BASE = location.origin + location.pathname.replace(/\/control\.html.*$/,'/') + 'overlay.html';

  // === ì—˜ë¦¬ë¨¼íŠ¸
  const $ = (id)=>document.getElementById(id);
  const $api = $('api');

  const inputs = {
    cardHex: $('cardHex'),
    cardAlpha: $('cardAlpha'),
    cardBlur: $('cardBlur'),
    cardShadow: $('cardShadow'),
    radius: $('radius'),
  };
  const outs = {
    cardAlphaOut: $('cardAlphaOut'),
    cardBlurOut: $('cardBlurOut'),
    cardShadowOut: $('cardShadowOut'),
    radiusOut: $('radiusOut'),
  };

  // ì €ì¥/ë¡œë“œ
  const store = {
    load(){
      $api.value = localStorage.getItem('overlay_api') || '';
      inputs.cardHex.value = localStorage.getItem('cardHex') || '#10131b';
      inputs.cardAlpha.value = localStorage.getItem('cardAlpha') || '55';
      inputs.cardBlur.value = localStorage.getItem('cardBlur') || '8';
      inputs.cardShadow.value = localStorage.getItem('cardShadow') || '35';
      inputs.radius.value = localStorage.getItem('radius') || '16';
      reflectOutputs();
      buildUrls();
    },
    save(){
      localStorage.setItem('overlay_api', $api.value.trim());
      localStorage.setItem('cardHex', inputs.cardHex.value);
      localStorage.setItem('cardAlpha', inputs.cardAlpha.value);
      localStorage.setItem('cardBlur', inputs.cardBlur.value);
      localStorage.setItem('cardShadow', inputs.cardShadow.value);
      localStorage.setItem('radius', inputs.radius.value);
      buildUrls();
    }
  };

  function reflectOutputs(){
    outs.cardAlphaOut.textContent = inputs.cardAlpha.value+'%';
    outs.cardBlurOut.textContent  = inputs.cardBlur.value+'px';
    outs.cardShadowOut.textContent= inputs.cardShadow.value;
    outs.radiusOut.textContent    = inputs.radius.value+'px';
  }

  // URL ìƒì„±
  function buildQuery(){
    const p = new URLSearchParams();
    if ($api.value.trim()) p.set('api', $api.value.trim());
    p.set('cardHex', inputs.cardHex.value);
    p.set('cardAlpha', inputs.cardAlpha.value);
    p.set('cardBlur', inputs.cardBlur.value);
    p.set('cardShadow', inputs.cardShadow.value);
    p.set('radius', inputs.radius.value);
    return p.toString();
  }
  function buildUrls(){
    const q = buildQuery();
    $('overlayUrl').value = GH_BASE + (q ? ('?' + q) : '');
    $('lyricsUrl').value  = GH_BASE + '?popup=lyrics' + (q ? ('&' + q) : '');
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  $('saveApi').addEventListener('click', ()=>{ store.save(); alert('ì €ì¥ ì™„ë£Œ'); });

  Object.values(inputs).forEach(el=>{
    el.addEventListener('input', ()=>{ reflectOutputs(); store.save(); });
  });

  function copy(id){ navigator.clipboard.writeText($(id).value).then(()=>alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n' + $(id).value)); }
  $('copyOverlay').addEventListener('click', ()=>copy('overlayUrl'));
  $('copyLyrics').addEventListener('click', ()=>copy('lyricsUrl'));
  $('openOverlay').addEventListener('click', ()=>window.open($('overlayUrl').value,'_blank'));
  $('openLyrics').addEventListener('click', ()=>window.open($('lyricsUrl').value,'lyrics_popup','width=420,height=700,resizable=yes,scrollbars=yes'));

  // ê°™ì€ PC ì‹¤ì‹œê°„ ì ìš© (BroadcastChannel)
  $('sendRealtime').addEventListener('click', ()=>{
    try{
      const bc = new BroadcastChannel('overlay-style');
      // CSS ë³€ìˆ˜ ê°’ ê³„ì‚° (ì˜¤ë²„ë ˆì´ ìª½ ê³„ì‚°ì‹ê³¼ ë™ì¼í•˜ê²Œ ë§Œë“¤ì–´ ì „ì†¡)
      const a = Math.max(0,Math.min(100,Number(inputs.cardAlpha.value)))/100;
      const hex = inputs.cardHex.value.replace('#','');
      const val = (hex.length===3?hex.split('').map(x=>x+x).join(''):hex);
      const n = parseInt(val,16);
      const r=(n>>16)&255,g=(n>>8)&255,b=n&255;
      const backdrop = `rgba(${r},${g},${b},${a})`;
      const shadow = `0 ${6+inputs.cardShadow.value/4}px ${18+inputs.cardShadow.value/2}px rgba(0,0,0,${0.15+inputs.cardShadow.value/160})`;

      bc.postMessage({
        type:'style-vars',
        payload:{
          '--card-backdrop': backdrop,
          '--card-blur': inputs.cardBlur.value+'px',
          '--card-shadow': shadow,
          '--radius': inputs.radius.value+'px'
        }
      });
      alert('ë³´ëƒˆìŠµë‹ˆë‹¤! (ê°™ì€ PCì—ì„œ overlay.htmlì„ ì—´ê³  ìˆì–´ì•¼ ì ìš©ë¼ìš”)');
    }catch(e){
      alert('ë¸Œë¼ìš°ì €ê°€ ì‹¤ì‹œê°„ ì „ì†¡ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.');
    }
  });

  // ì´ˆê¸° ë¡œë“œ
  store.load();
})();
</script>
</body>
</html>
