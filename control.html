<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>오버레이 컨트롤</title>
<style>
:root{ --panel:#0d1222; --fg:#eaf0ff; --muted:#9db0cf }
html,body{height:100%;margin:0}
body{background:#0b0f18;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
.app{display:grid;grid-template-columns:320px 1fr;gap:0;height:100%}
.left{background:#0f1628;border-right:1px solid #1c2740;padding:16px;overflow:auto}
.left h2{font-size:16px;margin:10px 0}
.row{display:flex;align-items:center;gap:8px;margin:10px 0}
input[type="color"]{width:56px;height:32px;border-radius:8px;border:1px solid #22324d;background:transparent;padding:0}
input[type="range"]{width:100%}
.btn{padding:10px 12px;border-radius:10px;border:1px solid #22324d;background:#121a31;color:#eaf0ff;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.right{padding:28px;overflow:auto}

/* 프리뷰 카드 */
:root{
  --card-w:640px; --radius:22px; --pad:16px; 
  --bg:#0b0b0f; --alpha:.55; --blur:8px; --shadow:0 16px 40px rgba(0,0,0,.35);
}
.card{ width:var(--card-w); border-radius:var(--radius); padding:var(--pad);
  backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
  background: color-mix(in oklab, var(--bg) calc(var(--alpha)*100%), transparent);
  box-shadow:var(--shadow); border:1px solid color-mix(in oklab, #fff 8%, #0000); }
.np{display:grid;grid-template-columns:180px 1fr;gap:16px;align-items:center}
.cover{width:180px;aspect-ratio:1/1;border-radius:14px;overflow:hidden;border:1px solid #00000022}
.cover img{width:100%;height:100%;object-fit:cover}
.title{font-weight:800;font-size:22px;line-height:1.25}
.sub{opacity:.9;font-size:14px;margin-top:2px}
.ctrls{display:flex;gap:12px;margin:8px 0}
.btn-sm{width:36px;height:36px;border-radius:999px;border:1px solid #12172333;background:#0e1320;color:#fff;display:grid;place-items:center}
.play{width:44px;height:44px;background:#fff;color:#111;border:none}
.wave{display:flex;gap:5px;align-items:flex-end;height:56px;margin-top:6px}
.bar{width:5px;background:#fff;border-radius:3px;opacity:.25}
.bar.active{opacity:1}
</style>
</head>
<body>
<div class="app">
  <aside class="left">
    <h2>오버레이 기본 주소</h2>
    <div class="row">
      <input id="ovUrl" class="url" style="flex:1" readonly>
      <button class="btn" id="copy">주소 복사</button>
    </div>

    <h2>카드 배경</h2>
    <div class="row"><label style="width:70px">색상</label><input type="color" id="hex" value="#0b0b0f"><span id="hexOut" class="small">#0B0B0F</span></div>
    <div class="row"><label style="width:70px">투명도</label><input type="range" id="alpha" min="0" max="100" value="55"><span class="small" id="alphaOut">55%</span></div>
    <div class="row"><label style="width:70px">블러</label><input type="range" id="blur" min="0" max="30" value="8"><span class="small" id="blurOut">8px</span></div>
    <div class="row"><label style="width:70px">그림자</label><input type="range" id="shadow" min="0" max="100" value="35"><span class="small" id="shadowOut">35</span></div>

    <h2>동작</h2>
    <button class="btn" id="openLyrics">가사 팝업 열기</button>
    <div class="small" id="saveState" style="margin-top:10px">저장됨</div>
  </aside>

  <main class="right">
    <div class="card">
      <div class="np">
        <div class="cover"><img src="assets/haming.png" alt=""></div>
        <div>
          <div class="title">프리뷰</div>
          <div class="sub">가수 / SING🎤 임하밍</div>
          <div class="ctrls">
            <div class="btn-sm">⏮</div><div class="btn-sm play">▶</div><div class="btn-sm">⏭</div>
          </div>
          <div class="wave" id="wave"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
const STORAGE_KEY = 'np.overlay.style.v3';
const qs = new URLSearchParams(location.search);
const API = (()=> {
  const p = qs.get('api'); if (p) return p.replace(/(\?|#).*$/,'');
  const m = (document.referrer||'').match(/https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec/);
  return m?m[0]:'';
})();

/* ✅ 깃허브 overlay.html 기준으로 주소 생성 */
const base = "https://wlgns4776-code.github.io/overlay/overlay.html";
const overlayUrl = `${base}?overlay=1&api=${encodeURIComponent(API)}&v=3`;
document.getElementById('ovUrl').value = overlayUrl;
document.getElementById('copy').onclick = ()=>navigator.clipboard.writeText(overlayUrl);

/* 파형(프리뷰) */
(function(){
  const wave=document.getElementById('wave'); const bars=40;
  const hs=Array.from({length:bars},(_,i)=>16+Math.round((Math.sin(i*1.2)*.5+.5)*40));
  const els=hs.map(h=>{const d=document.createElement('div');d.className='bar';d.style.height=h+'px';wave.appendChild(d);return d;});
  let idx=0; setInterval(()=>{els.forEach((el,i)=>el.classList.toggle('active',i<=idx)); idx=(idx+1)%bars;},260);
})();

/* 컨트롤 바인딩 */
const el = {
  hex:document.getElementById('hex'),
  alpha:document.getElementById('alpha'),
  blur:document.getElementById('blur'),
  shadow:document.getElementById('shadow'),
  hexOut:document.getElementById('hexOut'),
  alphaOut:document.getElementById('alphaOut'),
  blurOut:document.getElementById('blurOut'),
  shadowOut:document.getElementById('shadowOut'),
  saveState:document.getElementById('saveState'),
};
function applyToRoot(s){
  const r=document.documentElement;
  r.style.setProperty('--bg', s.hex||'#0b0b0f');
  r.style.setProperty('--alpha', String((s.alpha??55)/100));
  r.style.setProperty('--blur', (s.blur??8)+'px');
  const v = s.shadow??35;
  r.style.setProperty('--shadow', `0 ${6+v/4}px ${18+v/2}px rgba(0,0,0,${0.15+v/160})`);
}
function save(s){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    el.saveState.textContent = '저장됨';
  }catch(_){ el.saveState.textContent = '저장 실패'; }
}
function read(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch{ return {}; }
}
function syncFromInputs(){
  const s = {
    hex: el.hex.value,
    alpha: Number(el.alpha.value),
    blur: Number(el.blur.value),
    shadow: Number(el.shadow.value),
  };
  el.hexOut.textContent = el.hex.value.toUpperCase();
  el.alphaOut.textContent = s.alpha+'%';
  el.blurOut.textContent = s.blur+'px';
  el.shadowOut.textContent = s.shadow;
  applyToRoot(s); save(s);
}
function init(){
  const s = Object.assign({hex:'#0b0b0f',alpha:55,blur:8,shadow:35}, read());
  el.hex.value = s.hex; el.alpha.value = s.alpha; el.blur.value = s.blur; el.shadow.value = s.shadow;
  syncFromInputs();
}
['hex','alpha','blur','shadow'].forEach(id=>el[id].addEventListener('input', syncFromInputs));
init();

/* ✅ 가사 팝업 (별도 lyrics.html로 열기) */
document.getElementById('openLyrics').onclick = ()=>{
  if(!API) return alert('API 주소가 없어요');
  const url = `lyrics.html?api=${encodeURIComponent(API)}&_=${Date.now()}`;
  window.open(url, 'lyrics_popup',
    'width=460,height=720,left=80,top=80,resizable=yes,scrollbars=yes');
};
</script>
</body>
</html>
