<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Overlay Control</title>
<style>
:root{
  --bg:#0b0b0f; --fg:#f5f7fb; --muted:#a6afbd;
  --panel:#0f1320; --line:#243041;
  --radius:16px; --pad:14px;
  --card-w:640px;
  /* preview card defaults (ë™ì¼ ë³€ìˆ˜) */
  --card-backdrop: rgba(16,19,27,0.55);
  --card-blur: 8px;
  --card-shadow: 0 12px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
.page{display:grid;grid-template-columns:320px 1fr;height:100%}
.left{border-right:1px solid var(--line);background:var(--panel);padding:16px;overflow:auto}
.right{padding:18px;overflow:auto}

h2{font-size:16px;margin:10px 0 12px}
.row{display:flex;align-items:center;gap:8px;margin:10px 0}
input[type="color"]{width:56px;height:32px;border:1px solid var(--line);border-radius:8px;background:transparent}
input[type="range"]{width:100%}
.btn{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#12172a;color:var(--fg);cursor:pointer}
.muted{color:var(--muted)} .small{font-size:12px}

/* í”„ë¦¬ë·° ì¹´ë“œ (overlayì™€ ë™ì¼) */
.card{
  width:var(--card-w);
  max-width:var(--card-w);
  min-width:var(--card-w);
  border-radius:var(--radius);
  padding:var(--pad);
  border:1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(var(--card-blur));
  -webkit-backdrop-filter: blur(var(--card-blur));
  background:var(--card-backdrop);
  box-shadow:var(--card-shadow);
}
.np{display:grid;gap:16px;grid-template-columns:180px 1fr;align-items:center}
.np-cover{width:180px;aspect-ratio:1/1;border-radius:14px;background:#1114;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.np-cover img{width:100%;height:100%;object-fit:cover}
.np-title{font-weight:800;font-size:22px;line-height:1.3}
.np-artist{opacity:.85;font-size:14px;margin-top:2px}
.np-ctrls{display:flex;align-items:center;gap:14px;margin-top:8px}
.np-btn{width:34px;height:34px;border-radius:999px;border:1px solid rgba(255,255,255,.08);
  background:#0d111a;display:grid;place-items:center;color:#e8eefb}
.np-btn.primary{width:44px;height:44px;background:#fff;color:#111;border:none}
.np-wave{display:flex;gap:5px;align-items:flex-end;height:56px;margin-top:10px}
.np-barline{width:5px;background:#fff;border-radius:3px;opacity:.25;transition:opacity .15s}
.np-barline.active{opacity:1}

/* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ì •ë ¬ */
.previewWrap{min-height:100%;display:grid;place-items:start center}
</style>
</head>
<body>
<div class="page">
  <aside class="left">
    <h2>ì˜¤ë²„ë ˆì´ ê¸°ë³¸ ì£¼ì†Œ</h2>
    <div class="row">
      <input id="baseUrl" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0b0f1a;color:var(--fg)">
    </div>
    <div class="row">
      <button class="btn" id="btnCopy">ì£¼ì†Œ ë³µì‚¬</button>
    </div>
    <div class="small muted">ì´ ì£¼ì†Œë¥¼ ë°©ì†¡ í”„ë¡œê·¸ë¨(OBS/í”„ë¦­ìƒ· ë“±)ì˜ ë¸Œë¼ìš°ì € ì†ŒìŠ¤ë¡œ ë“±ë¡í•˜ì„¸ìš”.</div>

    <h2>ì¹´ë“œ ë°°ê²½</h2>
    <div class="row">
      <label style="width:80px">ìƒ‰ìƒ</label>
      <input id="cardColor" type="color" value="#10131b">
      <span class="muted" id="cardColorHex">#10131B</span>
    </div>
    <div class="row"><label style="width:80px">íˆ¬ëª…ë„</label><input id="cardAlpha" type="range" min="0" max="100" value="55"><span class="muted" id="cardAlphaOut">55%</span></div>
    <div class="row"><label style="width:80px">ë¸”ëŸ¬</label><input id="cardBlur" type="range" min="0" max="30" value="8"><span class="muted" id="cardBlurOut">8px</span></div>
    <div class="row"><label style="width:80px">ê·¸ë¦¼ì</label><input id="cardShadow" type="range" min="0" max="100" value="35"><span class="muted" id="cardShadowOut">35</span></div>

    <h2>ë™ì‘</h2>
    <div class="row"><button class="btn" id="btnLyrics">ê°€ì‚¬ íŒì—… ì—´ê¸°</button></div>
    <div class="small muted" id="status">ì—°ê²° OK</div>
  </aside>

  <main class="right">
    <div style="margin-bottom:12px">
      <label class="small muted">ë¯¸ë¦¬ë³´ê¸°</label>
    </div>
    <div class="previewWrap">
      <div class="card">
        <div class="np">
          <div class="np-cover"><img src="assets/haming.png" alt="cover"></div>
          <div class="np-main">
            <div class="np-title" id="pvTitle">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
            <div class="np-artist" id="pvSub"></div>
            <div class="np-ctrls">
              <button class="np-btn" title="ì´ì „">â®</button>
              <button class="np-btn primary" title="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶</button>
              <button class="np-btn" title="ë‹¤ìŒ">â­</button>
            </div>
            <div class="np-wave" id="pvWave"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
(() => {
  /* ===== ê¸°ë³¸ URL ì±„ìš°ê¸° ===== */
  const $ = id => document.getElementById(id);
  const baseOverlay = new URL('./overlay.html', location.href).href; // https://.../overlay/overlay.html
  const $baseUrl = $('baseUrl');
  const $status = $('status');

  // ì‚¬ìš©ìê°€ ë„˜ê¸´ api íŒŒë¼ë¯¸í„° ìœ ì§€
  const qs = new URLSearchParams(location.search);
  const apiFromQuery = qs.get('api') || '';
  const overlayUrl = baseOverlay + (apiFromQuery ? `?api=${encodeURIComponent(apiFromQuery)}` : '');
  $baseUrl.value = overlayUrl;

  $('btnCopy').addEventListener('click', ()=>{
    navigator.clipboard.writeText($baseUrl.value);
    $status.textContent = 'ì£¼ì†Œ ë³µì‚¬ ì™„ë£Œ';
  });

  /* ===== í”„ë¦¬ë·° íŒŒí˜• ===== */
  const pvWave = $('pvWave');
  const bars=40;
  const heights = Array.from({length:bars},(_,i)=> 16 + Math.round((Math.sin(i*1.2)*0.5+0.5)*40));
  const els = heights.map(h=>{
    const d=document.createElement('div'); d.className='np-barline'; d.style.height=h+'px';
    pvWave.appendChild(d); return d;
  });
  let idx=0;
  setInterval(()=>{ els.forEach((el,i)=> el.classList.toggle('active', i<=idx)); idx=(idx+1)%bars; }, 260);

  /* ===== ì¹´ë“œ ìŠ¤íƒ€ì¼ ì»¨íŠ¸ë¡¤ â†’ localStorage ì €ì¥ + ì¦‰ì‹œ ë°˜ì˜ ===== */
  const $cardColor=$('cardColor'), $cardColorHex=$('cardColorHex');
  const $cardAlpha=$('cardAlpha'), $cardAlphaOut=$('cardAlphaOut');
  const $cardBlur=$('cardBlur'), $cardBlurOut=$('cardBlurOut');
  const $cardShadow=$('cardShadow'), $cardShadowOut=$('cardShadowOut');

  function hexToRgb(hex){
    const m = hex.replace('#','');
    const v = (m.length===3? m.split('').map(x=>x+x).join(''): m);
    const n = parseInt(v,16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }
  function shadowVal(v){ v=Math.max(0,Math.min(100,Number(v))); return `0 ${6+v/4}px ${18+v/2}px rgba(0,0,0,${0.15+v/160})`; }

  function applyCardStyle(){
    const hex = $cardColor.value || '#10131b';
    const a = Math.max(0,Math.min(100,Number($cardAlpha.value)))/100;
    const blur = $cardBlur.value || 8;
    const sh = $cardShadow.value || 35;

    const {r,g,b} = hexToRgb(hex);
    document.documentElement.style.setProperty('--card-backdrop', `rgba(${r},${g},${b},${a})`);
    document.documentElement.style.setProperty('--card-blur', blur+'px');
    document.documentElement.style.setProperty('--card-shadow', shadowVal(sh));

    // í‘œì‹œ
    $cardColorHex.textContent = hex.toUpperCase();
    $cardAlphaOut.textContent = Math.round(a*100)+'%';
    $cardBlurOut.textContent = blur+'px';
    $cardShadowOut.textContent = sh;

    // ì €ì¥ (ì˜¤ë²„ë ˆì´ íƒ­ì— ì‹¤ì‹œê°„ ë°˜ì˜)
    localStorage.setItem('ov.cardColor', hex);
    localStorage.setItem('ov.cardAlpha', String(Math.round(a*100)));
    localStorage.setItem('ov.cardBlur',  String(blur));
    localStorage.setItem('ov.cardShadow', String(sh));

    // storage ì´ë²¤íŠ¸ê°€ ê°™ì€ íƒ­ì—ì„  ì•ˆëœ¨ë¯€ë¡œ ìˆ˜ë™ íŠ¸ë¦¬ê±°
    window.dispatchEvent(new StorageEvent('storage', { key:'ov.cardColor', newValue:hex }));
  }
  [$cardColor,$cardAlpha,$cardBlur,$cardShadow].forEach(el=> el.addEventListener('input', applyCardStyle));

  // ì´ˆê¸°ê°’(localStorage â†’ UI ë°˜ì˜)
  (function initFromStorage(){
    const hex   = localStorage.getItem('ov.cardColor')  || '#10131b';
    const alpha = localStorage.getItem('ov.cardAlpha')  || '55';
    const blur  = localStorage.getItem('ov.cardBlur')   || '8';
    const sh    = localStorage.getItem('ov.cardShadow') || '35';
    $cardColor.value  = hex;
    $cardAlpha.value  = alpha;
    $cardBlur.value   = blur;
    $cardShadow.value = sh;
    applyCardStyle();
  })();

  /* ===== í”„ë¦¬ë·°ì— ë°ì´í„° í‘œì‹œ (ì„ íƒ â€“ ì»¨íŠ¸ë¡¤ í™”ë©´ì—ì„œë„ ì œëª©/ê°€ìˆ˜ í™•ì¸) ===== */
  const $pvTitle = $('pvTitle'), $pvSub = $('pvSub');
  const API = apiFromQuery;
  async function fetchJson(url){
    const res = await fetch(url, {cache:'no-store'});
    const ct = res.headers.get('content-type')||'';
    if (ct.includes('application/json')) return res.json();
    const t = await res.text(); try{return JSON.parse(t);}catch{ throw new Error('Not JSON');}
  }
  async function tick(init){
    if (!API){ if (init){ $pvTitle.textContent='API ë¯¸ì„¤ì •'; $pvSub.textContent=''; } return; }
    try{
      const data = await fetchJson(API + (API.includes('?')?'&':'?') + 'nocache=' + Date.now());
      const singer = (data && data.singer) ? String(data.singer).trim() : '';
      const title  = (data && data.title ) ? String(data.title ).trim()  : '';
      $pvTitle.textContent = title || singer || 'ì²´í¬ëœ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤';
      $pvSub.textContent   = singer ? `${singer} / SINGğŸ¤ ì„í•˜ë°` : '';
    }catch(e){
      if (init){ $pvTitle.textContent='ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆì–´ìš”'; $pvSub.textContent=''; }
      console.error(e);
    }
  }
  tick(true); setInterval(tick, 2000);

  /* ===== ê°€ì‚¬ íŒì—… ===== */
  $('btnLyrics').addEventListener('click', ()=>{
    if (!API){ alert('APIê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. control.html?api= ë¡œ ì ‘ì†í•˜ì„¸ìš”.'); return; }
    const w = window.open('', 'lyrics_popup', 'width=420,height=700,left=80,top=80,resizable=yes,scrollbars=yes');
    const html = `
<!doctype html><html lang="ko"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ê°€ì‚¬</title>
<style>
  :root{ --bg:#0b0b0f; --fg:#f5f7fb; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
  #wrap{height:100%;padding:24px 26px;box-sizing:border-box}
  #lyrics{white-space:pre-wrap;line-height:1.7;font-size:20px;height:100%;overflow:auto}
</style></head><body>
<div id="wrap"><div id="lyrics">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
<script>
  const API=${JSON.stringify(API)};
  async function fetchJson(url){
    const r=await fetch(url,{cache:'no-store'});const ct=r.headers.get('content-type')||'';
    if(ct.includes('application/json'))return r.json();
    const t=await r.text();try{return JSON.parse(t)}catch{return {}}
  }
  async function tick(){
    try{
      const d=await fetchJson(API+(API.includes('?')?'&':'?')+'nocache='+Date.now());
      document.getElementById('lyrics').textContent = (d&&d.lyrics)?String(d.lyrics).trim():'ê°€ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
    }catch(_){}
  }
  tick(); setInterval(tick,2000);
<\/script></body></html>`;
    w.document.open(); w.document.write(html); w.document.close();
  });
})();
</script>
</body>
</html>
