<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>오버레이 컨트롤</title>
<style>
:root{
  --bg:#0b0b0f; --fg:#f5f7fb; --muted:#a6afbd; --panel:#0f1320; --border:#243041;
  --font:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--fg);font-family:var(--font);}

.app{display:grid;grid-template-columns:320px 1fr; min-height:100vh}
.side{padding:16px;border-right:1px solid var(--border);background:var(--panel);overflow:auto}
.main{padding:16px;overflow:auto}

h2{font-size:16px;margin:12px 0}
.row{display:flex;align-items:center;gap:8px;margin:8px 0}
.seg{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.seg button{padding:8px 10px;border:1px solid var(--border);background:#12172a;color:var(--fg);
  border-radius:10px;cursor:pointer;font-size:13px;white-space:nowrap}
.seg button.active{outline:2px solid var(--fg)}
input[type="range"]{width:100%}
input[type="color"]{width:56px;height:32px;border:1px solid var(--border);border-radius:8px;padding:0;background:transparent}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#12172a;color:var(--fg);cursor:pointer}
.small{font-size:12px;color:var(--muted)}
input[type="text"]{width:100%;padding:8px;border:1px solid var(--border);background:#0b0f1a;color:var(--fg);border-radius:8px}
iframe{width:100%;height:260px;border:none;border-radius:12px;background:#0000}
</style>
</head>
<body>
<div class="app">
  <aside class="side">
    <h2>오버레이 기본 주소</h2>
    <input id="outUrl" type="text" readonly />
    <div class="row"><button class="btn" id="btnCopy">주소 복사</button></div>
    <div class="small">이 주소를 방송 프로그램(OBS/프릭샷)의 브라우저 소스로 등록하세요.</div>

    <h2>프리셋</h2>
    <div class="seg" id="presets">
      <button data-preset="dark"  class="active">다크</button>
      <button data-preset="light">라이트</button>
      <button data-preset="darkA">다크A</button>
    </div>

    <h2>표시 카드 스타일</h2>
    <div class="seg" id="shapes">
      <button data-style="round" class="active">원형</button>
      <button data-style="square">사각형</button>
    </div>

    <h2>카드 배경</h2>
    <div class="row"><label style="width:70px">색상</label>
      <input id="cardColor" type="color" value="#942AFE"><span id="cardHex" class="small">#942AFE</span></div>
    <div class="row"><label style="width:70px">투명도</label><input id="cardA" type="range" min="0" max="100" value="55"><span class="small" id="oA">55%</span></div>
    <div class="row"><label style="width:70px">블러</label><input id="cardB" type="range" min="0" max="30" value="8"><span class="small" id="oB">8px</span></div>
    <div class="row"><label style="width:70px">그림자</label><input id="cardS" type="range" min="0" max="100" value="35"><span class="small" id="oS">35</span></div>

    <h2>동작</h2>
    <div class="seg">
      <button class="btn" id="btnPopup">가사 팝업 열기</button>
    </div>
    <div class="small" id="status">연결 확인 중…</div>
  </aside>

  <main class="main">
    <h2>미리보기</h2>
    <iframe id="preview" title="overlay preview"></iframe>
  </main>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  /* === 입력(컨트롤) 엘리먼트 === */
  const $presets = $('presets'); const $shapes = $('shapes');
  const $cardColor=$('cardColor'), $cardA=$('cardA'), $cardB=$('cardB'), $cardS=$('cardS');
  const $cardHex=$('cardHex'), $oA=$('oA'), $oB=$('oB'), $oS=$('oS');

  const DEFAULT_OVERLAY = location.origin + location.pathname.replace(/\/[^/]*$/, '') + '/overlay.html';
  const DEFAULT_COVER   = location.origin + location.pathname.replace(/\/[^/]*$/, '') + '/assets/haming.png';

  // 앱스 스크립트 API는 control.html의 ?api= 로 받기 (네가 붙인 주소 그대로 사용)
  const qs = new URLSearchParams(location.search);
  const API = qs.get('api') || '';
  if (!API) $('status').textContent = 'API 미설정: 주소 끝에 ?api=앱스스크립트exec 를 붙여서 이 페이지를 여세요.';
  else $('status').textContent = '연결 OK';

  /* === 상태 === */
  let theme='dark', shape='round';

  // 버튼 active 토글
  function setActive(container, target){
    [...container.children].forEach(b=>b.classList.remove('active'));
    target.classList.add('active');
  }
  $presets.addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b) return;
    theme=b.dataset.preset; setActive($presets,b); update();
  });
  $shapes.addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b) return;
    shape=b.dataset.style; setActive($shapes,b); update();
  });

  [$cardColor,$cardA,$cardB,$cardS].forEach(el=>el.addEventListener('input', ()=>{
    $cardHex.textContent = ($cardColor.value||'').toUpperCase();
    $oA.textContent = $cardA.value+'%';
    $oB.textContent = $cardB.value+'px';
    $oS.textContent = $cardS.value;
    update();
  }));

  function buildUrl(){
    const p = new URLSearchParams({
      api: API,
      theme, shape,
      card: $cardColor.value,
      cardA: $cardA.value,
      cardB: $cardB.value,
      cardS: $cardS.value,
      cover: DEFAULT_COVER,
      t: Date.now()
    });
    return `${DEFAULT_OVERLAY}?${p.toString()}`;
  }

  function update(){
    const url = buildUrl();
    $('outUrl').value = url;
    $('preview').src = url;
  }

  // 주소 복사
  $('btnCopy').addEventListener('click', ()=>{
    navigator.clipboard.writeText($('outUrl').value).then(()=>{
      $('status').textContent='주소 복사 완료!';
      setTimeout(()=>{$('status').textContent='연결 OK'}, 1500);
    });
  });

  // 가사 팝업
  $('btnPopup').addEventListener('click', ()=>{
    if (!API){ alert('API가 설정되지 않았어요. control.html?api=... 로 이 페이지를 여세요.'); return; }
    const w = window.open('', 'lyrics_popup',
      'width=420,height=700,left=60,top=60,resizable=yes,scrollbars=yes');
    if (!w){ alert('팝업이 차단되었습니다. 허용 후 다시 시도해 주세요.'); return; }
    const html = `
<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>가사</title>
<style>
  :root{ --bg:#0b0b0f; --fg:#f5f7fb; --font:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; }
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--fg);font-family:var(--font)}
  #wrap{height:100%;box-sizing:border-box;padding:24px 26px;}
  #lyrics{white-space:pre-wrap;line-height:1.7;font-size:20px;overflow:auto;height:100%;}
</style>
</head>
<body>
<div id="wrap"><div id="lyrics">불러오는 중…</div></div>
<script>
  const API=${JSON.stringify(API)};
  async function fetchJson(url){
    const res = await fetch(url,{cache:'no-store'});
    const ct = res.headers.get('content-type')||'';
    if (ct.includes('application/json')) return res.json();
    const t = await res.text(); try{return JSON.parse(t);}catch{return {};}
  }
  async function tick(){
    try{
      const d = await fetchJson(API + '?nocache=' + Date.now());
      const lyr = (d && d.lyrics) ? String(d.lyrics).trim() : '가사가 없습니다.';
      document.getElementById('lyrics').textContent = lyr;
    }catch(_){}
  }
  tick(); setInterval(tick, 2000);
<\/script>
</body></html>`;
    w.document.open(); w.document.write(html); w.document.close();
  });

  // 초기 적용
  update();
})();
</script>
</body>
</html>
